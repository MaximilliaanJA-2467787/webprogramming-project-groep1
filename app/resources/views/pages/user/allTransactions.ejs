<!-- All Transactions Hero Section -->
<section class="bg-primary text-white py-4" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important; margin-top: -1px;">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="display-5 fw-bold mb-3" style="color: white !important;">
          <i class="bi bi-receipt me-2"></i>Transaction History
        </h1>
        <p class="lead mb-0" style="color: rgba(255, 255, 255, 0.9) !important;">
          Complete overview of all your transactions
        </p>
      </div>
      <div class="col-lg-4 text-lg-end text-start mt-lg-0 mt-3">
        <div class="d-inline-flex align-items-center bg-white bg-opacity-10 rounded-3 p-3 backdrop-blur">
          <div class="text-end me-3">
            <div class="fw-semibold text-white-50 small">Current Balance</div>
            <div class="h3 mb-0 fw-bold text-white"><%= wallet.balance_tokens.toLocaleString() %> <small class="fs-6">tokens</small></div>
          </div>
          <div class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
            <i class="bi bi-wallet2 fs-4 text-white"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Transactions Content -->
<section class="py-5 bg-light">
  <div class="container">
    <!-- Filters and Search -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <form method="GET" action="/transactions" id="filterForm">
              <div class="row g-3">
                <!-- Search -->
                <div class="col-md-4">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-search me-2"></i>Search
                  </label>
                  <input type="text" class="form-control" name="search" placeholder="Item or vendor name..." value="<%= filters.search || '' %>">
                </div>

                <!-- Status Filter -->
                <div class="col-md-2">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-funnel me-2"></i>Status
                  </label>
                  <select class="form-select" name="status">
                    <option value="">All</option>
                    <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                    <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                    <option value="canceled" <%= filters.status === 'canceled' ? 'selected' : '' %>>Canceled</option>
                  </select>
                </div>

                <!-- Type Filter -->
                <div class="col-md-2">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-tag me-2"></i>Type
                  </label>
                  <select class="form-select" name="type">
                    <option value="">All</option>
                    <option value="purchase" <%= filters.type === 'purchase' ? 'selected' : '' %>>Purchase</option>
                    <option value="deposit" <%= filters.type === 'deposit' ? 'selected' : '' %>>Deposit</option>
                    <option value="withdraw" <%= filters.type === 'withdraw' ? 'selected' : '' %>>Withdraw</option>
                    <option value="transfer" <%= filters.type === 'transfer' ? 'selected' : '' %>>Transfer</option>
                  </select>
                </div>

                <!-- Date From -->
                <div class="col-md-2">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-calendar-event me-2"></i>From
                  </label>
                  <input type="date" class="form-control" name="dateFrom" value="<%= filters.dateFrom || '' %>">
                </div>

                <!-- Date To -->
                <div class="col-md-2">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-calendar-check me-2"></i>To
                  </label>
                  <input type="date" class="form-control" name="dateTo" value="<%= filters.dateTo || '' %>">
                </div>

                <!-- Filter Buttons -->
                <div class="col-12">
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-search me-2"></i>Apply Filters
                    </button>
                    <a href="/transactions" class="btn btn-outline-secondary">
                      <i class="bi bi-x-circle me-2"></i>Clear Filters
                    </a>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <small class="text-muted text-uppercase fw-semibold">Total Spent</small>
                <div class="h4 mb-0 fw-bold text-danger"><%= stats.totalSpent.toLocaleString() %></div>
                <small class="text-muted">tokens</small>
              </div>
              <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                <i class="bi bi-arrow-down-circle fs-4 text-danger"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <small class="text-muted text-uppercase fw-semibold">Total Received</small>
                <div class="h4 mb-0 fw-bold text-success"><%= stats.totalReceived.toLocaleString() %></div>
                <small class="text-muted">tokens</small>
              </div>
              <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                <i class="bi bi-arrow-up-circle fs-4 text-success"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <small class="text-muted text-uppercase fw-semibold">Total Transactions</small>
                <div class="h4 mb-0 fw-bold text-primary"><%= stats.count.toLocaleString() %></div>
                <small class="text-muted">transactions</small>
              </div>
              <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                <i class="bi bi-receipt fs-4 text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <small class="text-muted text-uppercase fw-semibold">Average Transaction</small>
                <div class="h4 mb-0 fw-bold text-info"><%= stats.average.toLocaleString() %></div>
                <small class="text-muted">tokens</small>
              </div>
              <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                <i class="bi bi-graph-up fs-4 text-info"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 pt-4 px-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="fw-bold mb-1">All Transactions</h5>
            <p class="text-muted small mb-0">Showing <%= pagination.offset + 1 %>-<%= Math.min(pagination.offset + pagination.limit, pagination.total) %> of <%= pagination.total %> transactions</p>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
              <i class="bi bi-printer me-1"></i>Print
            </button>
            <a href="/transactions/export" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-download me-1"></i>Export CSV
            </a>
          </div>
        </div>
      </div>
      
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="px-4">Date & Time</th>
                <th>Type</th>
                <th>Description</th>
                <th>Vendor/Location</th>
                <th class="text-end">Amount</th>
                <th class="text-center">Status</th>
                <th class="text-end px-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (!transactions || transactions.length === 0) { %>
                <tr>
                  <td colspan="7" class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3 mb-0">No transactions found</p>
                  </td>
                </tr>
              <% } else { %>
                <% transactions.forEach(function(tx) { 
                  const isIncoming = tx.walletDestination_id === wallet.id;
                  const amountClass = isIncoming ? 'text-success' : 'text-danger';
                  const amountPrefix = isIncoming ? '+' : '-';
                %>
                  <tr>
                    <td class="px-4">
                      <div class="fw-semibold"><%= new Date(tx.timestamp).toLocaleDateString('en-GB') %></div>
                      <small class="text-muted"><%= new Date(tx.timestamp).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) %></small>
                    </td>
                    <td>
                      <span class="badge bg-<%= tx.type === 'purchase' ? 'primary' : tx.type === 'deposit' ? 'success' : tx.type === 'withdraw' ? 'warning' : 'info' %>">
                        <i class="bi <%= tx.type === 'purchase' ? 'bi-bag' : tx.type === 'deposit' ? 'bi-arrow-down-circle' : tx.type === 'withdraw' ? 'bi-arrow-up-circle' : 'bi-arrow-left-right' %> me-1"></i>
                        <%= tx.type.charAt(0).toUpperCase() + tx.type.slice(1) %>
                      </span>
                    </td>
                    <td>
                      <div class="fw-semibold"><%= tx.item_name || 'General Transaction' %></div>
                      <% if (tx.item_category) { %>
                        <small class="text-muted">
                          <i class="bi bi-tag me-1"></i><%= tx.item_category %>
                        </small>
                      <% } %>
                    </td>
                    <td>
                      <% if (tx.vendor_name) { %>
                        <div><i class="bi bi-shop me-1"></i><%= tx.vendor_name %></div>
                      <% } %>
                      <% if (tx.vendor_location || tx.location) { %>
                        <small class="text-muted">
                          <i class="bi bi-geo-alt me-1"></i><%= tx.vendor_location || tx.location %>
                        </small>
                      <% } %>
                    </td>
                    <td class="text-end">
                      <div class="fw-bold <%= amountClass %>">
                        <%= amountPrefix %><%= tx.amount_tokens.toLocaleString() %> tok
                      </div>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-<%= tx.status === 'completed' ? 'success' : tx.status === 'pending' ? 'warning' : 'secondary' %>">
                        <%= tx.status.charAt(0).toUpperCase() + tx.status.slice(1) %>
                      </span>
                    </td>
                    <td class="text-end px-4">
                      <button class="btn btn-sm btn-outline-primary" onclick="showTransactionDetails('<%= tx.id %>')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </td>
                  </tr>
                <% }); %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <% if (pagination.totalPages > 1) { %>
        <div class="card-footer bg-white border-0 py-3 px-4">
          <nav aria-label="Transaction pagination">
            <ul class="pagination mb-0 justify-content-center">
              <li class="page-item <%= pagination.page <= 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?page=1&<%= new URLSearchParams(filters).toString() %>">
                  <i class="bi bi-chevron-double-left"></i>
                </a>
              </li>
              <li class="page-item <%= pagination.page <= 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= pagination.page - 1 %>&<%= new URLSearchParams(filters).toString() %>">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              
              <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
                <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>"><%= i %></a>
                </li>
              <% } %>
              
              <li class="page-item <%= pagination.page >= pagination.totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= pagination.page + 1 %>&<%= new URLSearchParams(filters).toString() %>">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              <li class="page-item <%= pagination.page >= pagination.totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= pagination.totalPages %>&<%= new URLSearchParams(filters).toString() %>">
                  <i class="bi bi-chevron-double-right"></i>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      <% } %>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm bg-gradient" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
          <div class="card-body text-center py-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-lightning-charge text-primary me-2"></i>Quick Actions</h5>
            <div class="d-flex flex-wrap justify-content-center gap-2">
              <a href="/wallet" class="btn btn-primary shadow-sm">
                <i class="bi bi-wallet2 me-2"></i>Go to Wallet
              </a>
              <a href="/analytics" class="btn btn-outline-secondary shadow-sm">
                <i class="bi bi-graph-up me-2"></i>View Analytics
              </a>
              <a href="/dashboard" class="btn btn-outline-secondary shadow-sm">
                <i class="bi bi-house me-2"></i>Dashboard
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Transaction Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="transactionDetails">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/ejs/transactions.js"></script>

<style>
.backdrop-blur {
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

@media print {
  .btn, .pagination, .card-header .btn-group {
    display: none !important;
  }
}
</style>
